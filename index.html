<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

  <!-- Twttier card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta property="og:image" content="https://ogremon.github.io/scheduler-today/twitter-card.png" />
  <meta property="og:title" content="Today's Schedule" />

  <title>Today's Schedule</title>
</head>

<body class="bg-info">
  <div class="container my-5 small">
    <div class="mt-5 text-center text-white">
      <h1 class="text-white">&#x1F31E;Today's Schedule&#x26F1;</h1>
      <div class="fs-5">Drag to make a schedule.</div>
      <div class="mb-3">
        <button class="btn btn-link" onclick="reset();">reset</button>
      </div>
    </div>
    <div class="mt-3 row">
      <div class="col-2"></div>
      <div class="col-8">
        <div id="scheduler">
          <div class="px-1 border-bottom text-white">AM6</div>
          <div class="period border-bottom text-white px-1 d-flex align-items-end" style="height: 4vh;"
            data-starttime="6">AM7</div>
          <div class="border-bottom text-white period px-1 d-flex align-items-end" style="height: 4vh;"
            data-starttime="7">AM8</div>
          <div class="border-bottom text-white period px-1 d-flex align-items-end" style="height: 4vh;"
            data-starttime="8">AM9</div>
          <div class="border-bottom text-white period px-1 d-flex align-items-end" style="height: 4vh;"
            data-starttime="9">AM10</div>
          <div class="border-bottom text-white period px-1 d-flex align-items-end" style="height: 4vh;"
            data-starttime="10">AM11</div>
          <div class="border-bottom text-white period px-1 d-flex align-items-end" style="height: 4vh;"
            data-starttime="11">PM12</div>
          <div class="border-bottom text-white period px-1 d-flex align-items-end" style="height: 4vh;"
            data-starttime="12">PM13</div>
          <div class="border-bottom text-white period px-1 d-flex align-items-end" style="height: 4vh;"
            data-starttime="13">PM14</div>
          <div class="border-bottom text-white period px-1 d-flex align-items-end" style="height: 4vh;"
            data-starttime="14">PM15</div>
          <div class="border-bottom text-white period px-1 d-flex align-items-end" style="height: 4vh;"
            data-starttime="15">PM16</div>
          <div class="border-bottom text-white period px-1 d-flex align-items-end" style="height: 4vh;"
            data-starttime="16">PM17</div>
          <div class="border-bottom text-white period px-1 d-flex align-items-end" style="height: 4vh;"
            data-starttime="17">PM18</div>
          <div class="border-bottom text-white period px-1 d-flex align-items-end" style="height: 4vh;"
            data-starttime="18">PM19</div>
          <div class="border-bottom text-white period px-1 d-flex align-items-end" style="height: 4vh;"
            data-starttime="19">PM20</div>
          <div class="border-bottom text-white period px-1 d-flex align-items-end" style="height: 4vh;"
            data-starttime="20">PM21</div>
          <div class="border-bottom text-white period px-1 d-flex align-items-end" style="height: 4vh;"
            data-starttime="21">PM22</div>
          <div class="border-bottom text-white period px-1 d-flex align-items-end" style="height: 4vh;"
            data-starttime="22">PM23</div>
          <div class="border-bottom text-white period px-1 d-flex align-items-end" style="height: 4vh;"
            data-starttime="23">AM0</div>
        </div>
      </div>
      <div class="col-2"></div>
      <div class="my-5 text-center">
        <iframe sandbox="allow-popups allow-scripts allow-modals allow-forms allow-same-origin"
          style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0"
          src="//rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=ogremon-todays-schedule-22&language=ja_JP&o=9&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=4839955557&linkId=5e0cb30f55f6363d344bc21034e8c34a"></iframe>
        <iframe sandbox="allow-popups allow-scripts allow-modals allow-forms allow-same-origin"
          style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0"
          src="//rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=ogremon-todays-schedule-22&language=ja_JP&o=9&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=4295008540&linkId=094928df918ed46697b3ff8fd0a59aea"></iframe>
      </div>
    </div>
  </div>

  <!-- Button trigger modal -->
  <button type="button" data-bs-toggle="modal" data-bs-target="#shceduleModal" id="trigger-modal"
    class="d-none">trigger</button>

  <!-- Modal -->
  <div class="modal fade" id="shceduleModal" tabindex="-1" aria-labelledby="shceduleModalLabel" aria-hidden="true"
    data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="shceduleModalLabel">Enter a title</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="cancelPeriod();"
            aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="input-group mb-3">
            <input type="text" class="form-control" id="title">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cancelPeriod();"
            data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="fixedPeriod();" data-bs-dismiss="modal">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>

  <script>
    var color_number = 0;
    function touchStartEvent(event) {
      event.preventDefault();
    }

    function touchMoveEvent(event) {
      event.preventDefault();
      var target = event.target;
      var touch = event.changedTouches[0];
      var gap = touch.pageY - window.pageYOffset - target.getBoundingClientRect().top;
      var number_of_selected_period = Math.floor(gap / target.clientHeight) + 1;
      var start_time = parseInt(target.dataset.starttime);
      var end_time = start_time + number_of_selected_period;
      var periods = document.getElementsByClassName("period");
      for (var i = 0; i < periods.length; ++i) {
        if (periods[i].classList.contains('fixed')) continue;
        var now_time = parseInt(periods[i].dataset.starttime);
        if (start_time <= now_time && now_time < end_time) {
          periods[i].classList.add('selected');
          periods[i].classList.add(getColorClass(color_number));
        } else {
          periods[i].classList.remove('selected');
          periods[i].classList.remove(getColorClass(color_number));
        }
      }
      target.dataset.endtime = end_time;
    }

    function touchEndEvent(event) {
      event.preventDefault();

      var target = event.target;
      if (parseInt(target.dataset.endtime) - parseInt(target.dataset.starttime) > 0) {
        document.getElementById('trigger-modal').click();
      }
    }

    function fixedPeriod() {
      var title = document.getElementById('title').value;
      var period = document.getElementsByClassName("period");
      var selected = [];
      for (var i = 0; i < period.length; ++i) {
        // 確定済のイベントを除く
        if (period[i].classList.contains('selected') && !period[i].classList.contains('fixed')) {
          selected.push(period[i]);
        }
      }

      for (var i = 0; i < selected.length; ++i) {
        if (i == 0) {
          var time = selected[i].innerHTML;
          selected[i].classList.add('d-flex');
          selected[i].classList.add('justify-content-between');
          selected[i].innerHTML = `<div>${time}</div><div class="fw-bold">${title}</div>`;

          // ローカルストレージに内容を保存
          var events = JSON.parse(localStorage.getItem('events'));
          if (events === null) events = [];
          var new_event = {
            title: title,
            starttime: selected[i].dataset.starttime,
            endtime: selected[i].dataset.endtime
          };
          events.push(new_event);
          localStorage.setItem('events', JSON.stringify(events));
        }
        selected[i].classList.add('fixed');

        // 不要な境界線を取り除く
        if (i != selected.length - 1) {
          selected[i].classList.remove('border-bottom');
        }

      }
      color_number++;
      document.getElementById('title').value = '';
    }

    function cancelPeriod() {
      var period = document.getElementsByClassName("period");
      for (var i = 0; i < period.length; ++i) {
        if (period[i].classList.contains('selected') && !period[i].classList.contains('fixed')) {
          period[i].classList.remove('selected');
          periods[i].classList.remove(getColorClass(color_number));
        }
      }
      document.getElementById('title').value = '';
    }

    function getColorClass(num) {
      var colorClassArray = ['bg-warning', 'bg-success', 'bg-primary', 'bg-danger']
      return colorClassArray[num % colorClassArray.length];
    }

    // 保存したスケジュールを表示
    function initialize() {
      var events = JSON.parse(localStorage.getItem('events'));
      if (events === null) return;
      var color_number = 0;
      for (var i = 0; i < events.length; ++i) {
        var period = document.getElementsByClassName("period");
        for (var j = 0; j < period.length; ++j) {
          // イベントの最初のブロックへの処理
          if (parseInt(period[j].dataset.starttime) == events[i].starttime) {
            period[j].classList.add('selected');
            period[j].classList.add('fixed');
            period[j].classList.add(getColorClass(color_number));
            var time = period[j].innerHTML;
            period[j].classList.add('d-flex');
            period[j].classList.add('justify-content-between');
            period[j].innerHTML = `<div>${time}</div><div class="fw-bold">${events[i].title}</div>`;

            if (events[i].endtime - events[i].starttime > 1) {
              period[j].classList.remove('border-bottom');
            }
          // イベントの中間のブロックへの処理
          } else if (events[i].starttime < parseInt(period[j].dataset.starttime) && parseInt(period[j].dataset.starttime) < events[i].endtime - 1) {
            period[j].classList.add('selected');
            period[j].classList.add('fixed');
            period[j].classList.add(getColorClass(color_number));
            period[j].classList.remove('border-bottom');
          // イベントの最後のブロックへの処理
          } else if (parseInt(period[j].dataset.starttime) == events[i].endtime - 1) {
            period[j].classList.add('selected');
            period[j].classList.add('fixed');
            period[j].classList.add(getColorClass(color_number));
          }
        }
        color_number++;
      }
    }

    function reset() {
      localStorage.removeItem('events');
      location.reload();
    }

    {
      var periods = document.getElementsByClassName("period");
      for (var i = 0; i < periods.length; ++i) {
        var item = periods[i];
        item.addEventListener('touchstart', touchStartEvent, false);
        item.addEventListener('touchmove', touchMoveEvent, false);
        item.addEventListener('touchend', touchEndEvent, false);
      }

      initialize();
    }
  </script>
  </div>


</body>

</html>